services:
  docker-host:
    build: .
    container_name: secure-docker-host
    privileged: true
    ports:
      - "2222:22"
      - "2376:2376"
      - "2377:2377"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - docker-data:/var/lib/docker
      - docker-config:/etc/docker
      - firewall-config:/etc/firewalld
      - ssh-keys:/home/docker/.ssh
      - docker-tls-certs:/etc/docker/certs
      - ./containers:/opt/containers:ro
    environment:
      - DOCKER_TLS_CERTDIR=/etc/docker/certs
      - DOCKER_HOST=tcp://0.0.0.0:2376
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    networks:
      - host-network
    healthcheck:
      test: ["CMD", "systemctl", "is-active", "firewalld"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  docker-data:
    driver: local
  docker-config:
    driver: local
  firewall-config:
    driver: local
  ssh-keys:
    driver: local
  docker-logs:
    driver: local
  wireguard-config:
    driver: local
  docker-tls-certs:
    driver: local
  n8n-data:
    driver: local

networks:
  host-network:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.25.0.0/16
  secure-net:
    driver: bridge
    internal: true