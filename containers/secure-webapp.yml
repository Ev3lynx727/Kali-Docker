# Example Secure Web Application
# This demonstrates best practices for running web apps securely

version: '3.8'

services:
  webapp:
    image: nginx:alpine
    container_name: secure-webapp
    networks:
      - secure-net
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./html:/usr/share/nginx/html:ro
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
      - /var/run:noexec,nosuid,size=10m
      - /var/cache/nginx:noexec,nosuid,size=50m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    user: "101:101"  # nginx user
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      security.scan=true
      monitoring.enabled=true

  database:
    image: postgres:15-alpine
    container_name: secure-database
    networks:
      - secure-net
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - db_data:/var/lib/postgresql/data
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    user: "70:70"  # postgres user
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d myapp"]
      interval: 30s
      timeout: 10s
      retries: 3

secrets:
  db_password:
    file: ./secrets/db_password.txt

volumes:
  db_data:
    driver: local

networks:
  secure-net:
    driver: bridge
    internal: true